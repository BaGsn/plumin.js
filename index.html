<!doctype html>
<html class="no-js">
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title>Plumin.js | Create and Manipulate fonts like there's no tomorrow.</title>
		<meta name="description" content="">
		<!-- it's an app, disable zooming on mobile devices -->
		<meta name="viewport" content="target-densitydpi=device-dpi, initial-scale=1.0, user-scalable=no" />
		<!-- Place favicon.ico and apple-touch-icon.png in the root directory -->

		<link rel="stylesheet" href="bower_components/knacss/css/knacss.css">
		<link rel="stylesheet" href="bower_components/codemirror/lib/codemirror.css">
		<style>
			html,
			body,
			body > .row > .col {
				height: 100%;
			}

			h1 {
				height: 100px;
				margin: 0;
			}

			body > .row {
				height: calc( 100% - 100px );
			}

			textarea.editor,
			textarea.result {
				width: 100%;
				/* Doesn't work in Chrome :-/
				height: calc( 100% - 100px ); */
				height: 400px;

				margin: 0;
			}

			textarea.editor,
			.CodeMirror {
				font-size: 20px;
			}

			textarea.result {
				padding: 20px;

				border: 0;
				border-radius: 0;

				font-family: 'Demo', sans-serif;
				font-size: 50px;

				resize: none;
			}

			.btn {
				border: 1px solid #CCC;
				border-radius: 3px;

				margin-top: 10px;
				padding: 5px 10px;

				font-size: 25px;
				text-decoration: none;
			}
		</style>

	</head>
	<body>
		<!--[if lt IE 10]>
			<p class="chromeframe">You are using an outdated browser. <a href="http://browsehappy.com/">Upgrade your browser today</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to better experience this site.</p>
		<![endif]-->

		<h1 class="pam">
			<img src="plumin.png" alt="Plumin.js" style="height: 50px;">
			<span class="h2" style="vertical-align: -12px">
			&nbsp;–&nbsp;&nbsp;create and manipulate fonts like no one's watching.
			</span>
		</h1>

		<div class="row">
			<div class="col w50 plm">
				<textarea id="editor" class="editor">
(function(p) {

var font = p(p.Font, {
		familyName: 'Demo'
	}),

	// glyphs
	A = p(p.Glyph, {
		name: 'A',
		advanceWidth: 512
	}),
	B = p(p.Glyph, {
		name: 'B',
		advanceWidth: 512
	}),
	C = p(p.Glyph, {
		name: 'C',
		advanceWidth: 512
	}),

	// contours
	ctA = p(p.Path, { closed: true }),
	ctB = p(p.Path, { closed: true }),
	ctC = p(p.Path, { closed: true });

ctA.addNodes(p.Node, [
	{ point: [50, 0] },
	{ point: [256, 800] },
	{ point: [462, 0] }
]);

ctB.addNodes(p.Node, [
	{ point: [50, 0] },
	{ point: [50, 800] },
	{ point: [462, 800] },
	{ point: [462, 0] }
]);

ctC.addNodes(p.Node, [
	{
		point: [50, 400],
		handleIn: [0, -200],
		handleOut: [0, 200]
	},
	{
		point: [256, 800],
		handleIn: [-200, 0],
		handleOut: [200, 0]
	},
	{
		point: [462, 400],
		handleIn: [0, 200],
		handleOut: [0, -200]
	},
	{
		point: [256, 0],
		handleIn: [200, 0],
		handleOut: [-200, 0]
	}
]);

A.addContour(ctA);
B.addContour(ctB);
C.addContour(ctC);

window.font = font.addGlyphs([
		A,
		B,
		C
	])
	.prepareOT()
	.addToFonts();

/*
// animation are only fluid in Chrome
var center = p(p.Point, [256, 400]);
window.onFrame = function() {
	ctA.rotate(3, center);
	ctB.rotate(-3, center);
	ctC.rotate(3, center);

	font.prepareOT()
		.addToFonts();
};
*/

})(plumin);
				</textarea>

				<div class="mtm txtcenter">
					<a href="#" class="btn" onclick="_run();">▷ Run</a> <label><input id="workerSwitch" type="checkbox"/> Using a WebWorker</label>
				</div>
			</div>
			<div class="col w50">
				<textarea id="result" class="result pal">
 A B C
 (I'm a textarea!)
 				</textarea>

				<div class="mtm txtcenter">
					<a href="#" class="btn" onclick="_download();" download="demo.otf">▽ Download</a>
				</div>
			</div>
		</div>

		<canvas id="hidden-canvas" width="1024" height="1024" hidden />

		<script src="bower_components/codemirror/lib/codemirror.js"></script>
		<script src="bower_components/codemirror/mode/javascript/javascript.js"></script>
		<script src="bower_components/codemirror/addon/edit/closebrackets.js"></script>
		<script src="dist/plumin.js"></script>

		<script>
			plumin.paper.setup('hidden-canvas');

			var cm = CodeMirror.fromTextArea( document.getElementById('editor'), {
				autoCloseBrackets: true
			});
			cm.setSize('100%', document.getElementById('result').offsetHeight );

			var _URL = window.URL || window.webkitURL,
				lastBuffer,
				request,
				worker,
				pluminSource,
				workerSwitch = document.getElementById('workerSwitch'),
				xhr = new XMLHttpRequest(),
				_font = new plumin.Font({
					familyName: 'Demo'
				});

			xhr.open('GET', 'dist/plumin.js', true);
			xhr.onload = function(e) {
				if ( this.status === 200 ) {
					pluminSource = this.response;
				}
			};
			xhr.send();

			function _run() {
				// stop previous run
				if ( request ) {
					cancelAnimationFrame(request);
					window.onFrame = false;
					if ( worker ) {
						worker.terminate();
					}
				}

				return workerSwitch.checked ?
					_runWorker():
					_runNoWorker();
			}

			function _runNoWorker() {
				/*jslint evil: true */
				try {
					( new Function( cm.getValue() ) )();
				} catch(e) {
					console.error(e);
				}

				if ( window.onFrame ) {
					(function _onFrame() {
						window.onFrame();

						request = requestAnimationFrame(_onFrame);
					})();
				}
			}

			function _runWorker() {
				worker = new Worker(
					_URL.createObjectURL( new Blob(
						[
							'var window = self;\n' +

							// importScripts doesn't work with inline worker.
							// You wouldn't use inline workers and this trick in prod, though.
							pluminSource + '\n' +

							'plumin.paper.setup({\n' +
							'	width: 1024,\n' +
							'	height: 1024\n' +
							'});\n' +

							'var acceptMessage = true;\n' +

							'plumin.Font.prototype.addToFonts = function() {\n' +
							'	var buffer = this.ot.toBuffer();\n' +
							'	postMessage( buffer, [buffer] );\n' +
							'	acceptMessage = true;\n' +
							'};\n' +

							'onmessage = function() {\n' +
							'	if ( acceptMessage && self.onFrame ) {\n' +
							// don't accept new messages until we have finished generating this font
							'		acceptMessage = false;\n' +
							'		self.onFrame();\n' +
							'	}\n' +
							'};\n' +
							cm.getValue()
						],
						{type: "text/javascript"}
					))
				);

				worker.onmessage = function(e) {
					_font.addToFonts( lastBuffer = e.data );
				};

				(function _onFrame() {
					worker.postMessage('frame');

					request = requestAnimationFrame(_onFrame);
				})();
			}

			function _download() {
				return lastBuffer ?
					_font.download( lastBuffer ):
					window.font
						.prepareOT()
						.download();
			}
		</script>

		<script>
			/* jshint ignore:start */
			// HANDJS shouldn't process the css
			//HANDJS.doNotProcessCSS = true;
			// google analytics
			var _gaq=[['_setAccount','UA-41962243-3'],['_trackPageview']];
			(function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
			g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
			s.parentNode.insertBefore(g,s)}(document,'script'));
		</script>
	</body>
</html>
